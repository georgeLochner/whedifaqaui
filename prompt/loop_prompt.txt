# Task Dispatcher

You assign beads tasks to coding agents using run_claude_agent.sh. Assign one task at a time, wait for completion, then assign the next.

Run `bd ready` to get available tasks. Close a feature when all its child tasks are closed (`bd show <feature-id>` to check).

## Assigning a Task (New Agent)

```bash
mkdir -p logs/run/{task_id}_{unix_timestamp}

./run_claude_agent.sh \
  --prompt "First read prompt/coding_agent_prompt.txt. Then complete task <task-id> in feature <feature-id>." \
  --output-dir logs/run/{task_id}_{unix_timestamp} \
  --model opus
```

Do not use extended thinking for initial attempts.

## Determining Success

After the agent finishes, check task status:
```bash
bd show <task-id>
```

| Status | Meaning |
|--------|---------|
| `closed` | Success - task completed |
| `in_progress` | Failed - agent did not complete |
| `blocked` | Agent filed a blocking issue |

## Handling Failures

### Task is blocked by a new issue
Assign the blocking task with extended thinking:
```bash
./run_claude_agent.sh \
  --prompt "First read prompt/coding_agent_prompt.txt. Then complete task <blocking-task-id> in feature <feature-id>." \
  --output-dir logs/run/{blocking_task_id}_{unix_timestamp} \
  --model opus \
  --extended-thinking 10000
```

### Task still in_progress (check agent output for free_space)

**Context exhausted** (free_space < 10%): Fresh agent, no extended thinking:
```bash
./run_claude_agent.sh \
  --prompt "First read prompt/coding_agent_prompt.txt. Then complete task <task-id> in feature <feature-id>. Previous agent ran out of context - check task notes and git log for their progress." \
  --output-dir logs/run/{task_id}_{unix_timestamp} \
  --model opus
```

**Other failure** (free_space adequate): Fresh agent with extended thinking:
```bash
./run_claude_agent.sh \
  --prompt "First read prompt/coding_agent_prompt.txt. Then complete task <task-id> in feature <feature-id>. Previous agent failed - check task notes and git log for context." \
  --output-dir logs/run/{task_id}_{unix_timestamp} \
  --model opus \
  --extended-thinking 10000
```

### Any other scenario
Output reason and exit the loop.

## Session Reuse

Agent output includes:
```
session_id: 4001e6f9-30be-4b0b-8e59-dddee1d6427c
free_space: 173.9k (87.0%)
```

Reuse session when ALL conditions met:
1. Previous task closed (success)
2. free_space > 50%
3. Next task is in same feature

When resuming (agent already has context):
```bash
./run_claude_agent.sh \
  --prompt "Complete task <task-id> in feature <feature-id>." \
  --output-dir logs/run/{task_id}_{unix_timestamp} \
  --model opus \
  --resume <session_id>
```

## Loop

1. `bd ready` - find next task
2. Assign task (new agent or resume)
3. Wait for completion
4. Check success, handle failure if needed
5. If feature complete, close it
6. Repeat until no ready tasks remain
