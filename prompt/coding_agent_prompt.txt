# Coding Agent Protocol

## Environment

All commands run inside Docker containers via `docker compose exec <service> <command>`.

**Start services with this command:**

```bash
# Always use development mode (code volume-mapped, hot reload enabled)
docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# Verify running
curl -s http://localhost:8000/api/health | grep -q '"status":"ok"' && echo "Backend OK"
curl -s http://localhost:9200/_cluster/health | grep -q '"status"' && echo "OpenSearch OK"

# Run commands in containers
docker compose exec backend pytest tests/unit/test_video.py -v
docker compose exec backend alembic upgrade head
docker compose exec frontend npm test

# Stop services
docker compose down
```

Services: backend(:8000), frontend(:3000), postgres(:5432), opensearch(:9200), redis(:6379)

**Key Principle:** Edit code on host filesystem (not inside containers). Changes reflect immediately in running containers. No rebuild needed.

**Adding Dependencies:** When you add a package to `package.json` or `requirements.txt`, install it inside the running container â€” do NOT rebuild the image:

```bash
# Backend: after editing requirements.txt
docker compose exec backend pip install -r requirements.txt

# Frontend: after editing package.json
docker compose exec frontend npm install
```

Only use `docker compose build` for Dockerfile changes (base image, system packages, build steps).

---

## Task Start

1. Run `bd show <feature-id>` and `bd show <task-id>` for context
2. If other tasks in the feature are already closed: review their descriptions to understand what's built
3. If current task has notes from previous agent: check `git status`, `git log`, review their progress
4. Run `bd update <task-id> --status=in_progress`

---

## During Work

- Commit incrementally after each logical unit of progress
- Reference task-id in commit messages

---

## Verification Loop

Before closing any task, you MUST verify your implementation works:

1. **Run the tests specified in the task description**
   ```bash
   docker compose exec backend pytest path/to/test.py -v
   ```

2. **If tests fail:**
   - Read the failure output carefully
   - Fix the issue in your code
   - Run the tests again
   - Repeat until all tests pass

3. **If no tests are specified, verify manually:**
   - For API endpoints: `curl` or use the API
   - For frontend components: check browser at localhost:3000
   - For models/migrations: verify with `alembic upgrade head`

4. **Only close the task when:**
   - All specified tests pass
   - No regressions in related tests
   - Code is committed

**Do NOT close a task with failing tests.** The tests are your signal that the implementation is correct.

---

## Task Complete

Before closing, ask yourself: **Did I take any shortcuts I know are suboptimal?**
(Missing error handling, hardcoded values, skipped validation, incomplete tests, TODO comments, etc.)

If yes: Either fix them now, or create a follow-up task to track the technical debt.

Only close when fully done (code works, tests pass, changes committed, no untracked shortcuts):
```bash
bd close <task-id>
```

---

## Context Limit Reached

If you cannot finish (read 10+ files, 15+ turns, task larger than expected):

1. Add handoff note to task:
   ```bash
   bd update <task-id> --description="[original description]

   ---
   Handoff: Completed X. Remaining: Y. Modified: file1, file2."
   ```

2. Commit with message noting partial progress
3. Leave task open and exit

---

## Rules

- Only work on your assigned task - do not start additional tasks
- Exit after completing (or handing off) your assigned task
- Never close incomplete tasks
- Never close tasks with failing tests
- Never redo work previous agents committed
- Never change Docker image versions (specified in "Docker Image Versions" section in docs/design/technology-stack.md)
- Tasks should modify 1-3 files, read 5-8 max
